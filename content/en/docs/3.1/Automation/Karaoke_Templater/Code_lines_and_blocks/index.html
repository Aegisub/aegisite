<!DOCTYPE html>
<html>

<!-- Mirrored from docs.aegisub.org/3.1/Automation/Karaoke_Templater/Code_lines_and_blocks/ by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 08 Jul 2020 19:49:04 GMT -->
<head>
<meta charset='utf-8'>
<title>Code lines and blocks - Aegisub Manual</title>
<meta content='Aegisub, Subtitles, VSFilter, Medusa, Sabbu, ' name='Keywords'>
<meta content='http://www.aegisub.org/' name='Author'>
<meta content='Copyright (C) 2012 Aegisub Project.' name='Copyright'>
<link href='../../../../3.2/Automation/Karaoke_Templater/Code_lines_and_blocks/index.html' rel='canonical'>
<link href="../../../img/favicon.ico" rel="icon" type="image/ico" />
<link href="../../../css/style-144d38ad.css" media="screen" rel="stylesheet" type="text/css" />
</head>
<body>
<div class='navbar navbar-fixed-top'>
<div class='navbar-inner'>
<div class='container-fluid'>
<a class="brand" style="padding: 3px 10px" href="http://www.aegisub.org/"><img alt="Aegisub" width="82" height="33" src="../../../img/logo-top-bar-aeef0634.png" />
</a>
<ul class='nav'>
<li>
<a href="http://www.aegisub.org/">Home</a>
</li>
<li>
<a href="http://blog.aegisub.org/">News</a>
</li>
<li>
<a href="http://www.aegisub.org/downloads/">Downloads</a>
</li>
<li class='active'>
<a href="../../../../index.html">Manual</a>
</li>
<li>
<a href="http://devel.aegisub.org/">Bug Tracker</a>
</li>
<li>
<a href="http://forum.aegisub.org/">Forum</a>
</li>
<li>
<a href="irc://irc.rizon.net/aegisub">IRC</a>
</li>
</ul>
<ul class='nav pull-right'>
<li>
<form action='https://www.paypal.com/cgi-bin/webscr' method='post' style='padding: 13px 0 6px 0; margin: 0' target='_top'>
<input name='cmd' type='hidden' value='_s-xclick'>
<input name='encrypted' type='hidden' value='-----BEGIN PKCS7-----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-----END PKCS7-----'>
<input alt='PayPal - The safer, easier way to pay online!' border='0' name='submit' src='https://www.paypalobjects.com/en_US/i/btn/btn_donate_SM.gif' type='image'>
<img alt='' border='0' height='1' src='https://www.paypalobjects.com/en_US/i/scr/pixel.gif' width='1'>
</form>
</li>
<li>
<a href='http://flattr.com/thing/922938/Aegisub-Advanced-Subtitle-Editor' target='_blank'>
<img alt='Flattr this' src='http://api.flattr.com/button/flattr-badge-large.png' title='Flattr this'>
</a>
</li>
</ul>
</div>
</div>
</div>
<div class='fluid-row'>
<div class='span3'>
<ul id='manual-sidebar'>
<li class='nav-header'>Navigation</li>
<li>
<a href="../../../Main_Page/index.html">Main Page</a>
</li>
<li class='nav-header'>Introduction</li>
<li>
<a href="../../../About/index.html">What is Aegisub?</a>
</li>
<li>
<a href="../../../Highlights/index.html">Highlights</a>
</li>
<li>
<a href="../../../Credits/index.html">Credits</a>
</li>
<li>
<a href="../../../Support/index.html">Support Aegisub</a>
</li>
<li>
<a href="../../../FAQ/index.html">FAQ</a>
</li>
<li>
<a href="../../../Tutorials/index.html">Tutorials</a>
</li>
<li class='nav-header'>Working with Subtitles</li>
<li>
<a href="../../../Editing_Subtitles/index.html">Editing Subtitles</a>
</li>
<li>
<a href="../../../Exporting/index.html">Exporting Subtitles</a>
</li>
<li>
<a href="../../../Attaching_subtitles_to_video/index.html">Applying Subtitles</a>
</li>
<li>
<a href="../../../Spell_Checker/index.html">Spell Checker</a>
</li>
<li>
<a href="../../../Translation_Assistant/index.html">Translation Assistant</a>
</li>
<li>
<a href="../../../Paste_Over/index.html">Paste Over</a>
</li>
<li>
<a href="../../../Select_Lines/index.html">Select Lines</a>
</li>
<li class='nav-header'>Typesetting</li>
<li>
<a href="../../../Typesetting/index.html">Introduction</a>
</li>
<li>
<a href="../../../Video/index.html">Working with Video</a>
</li>
<li>
<a href="../../../Styles/index.html">Editing styles</a>
</li>
<li>
<a href="../../../Visual_Typesetting/index.html">Visual Typesetting</a>
</li>
<li>
<a href="../../../ASS_Tags/index.html">ASS Override Tags</a>
</li>
<li>
<a href="../../../Colour_Picker/index.html">Colour Picker</a>
</li>
<li>
<a href="../../../Styling_Assistant/index.html">Styling Assistant</a>
</li>
<li>
<a href="../../../Resolution_Resampler/index.html">Resolution Resampler</a>
</li>
<li>
<a href="../../../Fonts_Collector/index.html">Fonts Collector</a>
</li>
<li class='nav-header'>Timing</li>
<li>
<a href="../../../Audio/index.html">Working with Audio</a>
</li>
<li>
<a href="../../../Timing/index.html">Timing subtitles to audio</a>
</li>
<li>
<a href="../../../Shift_Times/index.html">Shift times</a>
</li>
<li>
<a href="../../../Timing_Post-Processor/index.html">Timing Post-Processor</a>
</li>
<li>
<a href="../../../Kanji_Timer/index.html">Kanji Timer</a>
</li>
<li class='nav-header'>Automation</li>
<li>
<a href="../../index.html">Overview</a>
</li>
<li>
<a href="../index.html">Karaoke Templater</a>
</li>
<li>
<a href="../../Lua/index.html">Lua Reference</a>
</li>
<li class='nav-header'>Miscellaneous</li>
<li>
<a href="../../../Options/index.html">Aegisub Options</a>
</li>
<li>
<a href="../../../Properties/index.html">Script Properties</a>
</li>
<li>
<a href="../../../Attachment_Manager/index.html">Attachment Manager</a>
</li>
</ul>
</div>
<div class='span9' id='manual-body'>
<h1 class='page-header'><a href="../../index.html">Automation</a> / <a href="../index.html">Karaoke Templater</a> / Code lines and blocks</h1>
<p>Code lines and blocks in Karaoke Templater allows you to create advanced
effects by incorporating small snippets of Lua code. This can range from simple
mathematical expressions adding two numbers to complex functions that for
example could generate various shapes in cycling colours.</p>

<p>Both code lines and code blocks are run in a separate semi-closed execution
environment, meaning they are mostly undisturbed by the primary Lua environment
the Karaoke Templater script itself runs in. For an overview of what variables
are available in the code line/block execution environment see: <a href="../../../Automation/Karaoke_Templater/Code_execution_environment/index.html">Code
execution environment</a>.</p>

<h2 id="code-lines">Code lines</h2>

<p>A code line is a special kind of template line. Instead of using the <code>template</code>
keyword in the Effect field it uses the <code>code</code> keyword. A code line contains
only Lua code and does not by itself produce any lines in the resulting file.</p>

<p>The two primary uses of code lines are:</p>

<ul>
  <li>Defining/updating variables for use later in templates</li>
  <li>Defining functions for use later in templates</li>
</ul>

<p>For example, if you need a random number, but also need to use it twice in one
template, you can use a code line to first generate the number and store it to
a variable, then use that variable in your template line.</p>

<p>Another example could be defining a function that produces a random colour.</p>

<h3 id="classes-of-code-lines">Classes of code lines</h3>

<p>Like there's multiple classes of template lines there's also multiple classes
of code lines. Some of them are the same, and some only exist for one or the
other.</p>

<p>You specify the class of the code line in the Effect field after the <code>code</code>
keyword. The possible classes are:</p>

<dl>
  <dt>once</dt>
  <dd>Code lines in the <code>once</code> class are run exactly one time, before any templates
are applied. This is usually the best place to define functions and general
tables of values you need to look up later.  This is the default class, if you
don't specify a class for a code line it's automatically in the <code>once</code> class.</dd>
  <dt>line</dt>
  <dd>Code lines in the <code>line</code> class are run when a new line is encountered. They
are run once per line. They are run interspersed with <code>line</code>/<code>pre-line</code>
templates in the order they appear. (There are no "pre-line" code lines.)</dd>
  <dt>syl</dt>
  <dd>Code lines in the <code>syl</code> class are run when a new syllable is encountered.
They run once per syllable. They are run interspersed with <code>syl</code> templates.</dd>
  <dt>furi</dt>
  <dd>Code lines in the <code>furi</code> class are run when a new furigana syllable is
encountered. They run once per furigana syllable.  They are run interspersed
with <code>furi</code> templates.</dd>
</dl>

<p>You <em>cannot</em> have templates with <code>char</code> or <code>multi</code> modifiers run
per-character/per-highlight interspersed with code lines. This is a limitation
of the execution model. This may or may not change in later versions of Karaoke
Templater.</p>

<h2 id="code-blocks">Code blocks</h2>

<p>A code block is a block of Lua code within a template line. Code blocks are
used to insert more complex things than can be expressed with <a href="../../../Automation/Karaoke_Templater/Inline_variables/index.html">inline
variables</a>.</p>

<p>Code blocks are required to be single Lua expressions, since a <code>return</code>
statement is automatically prepended to the code. This means you (among other
things) can't do assignments or use <code>if</code> statements within code blocks, you
must use a code line if you want to do any of those things. (There is a way to
do basic conditionals in code blocks though, see below.)</p>

<p>You create a code block by surrounding the code by exclamation marks, like
this:</p>

<pre class="highlight text">{\t($start,!syl.start_time+20!,\bord0)}
</pre>
<p>It is possible to use inline variables within code blocks. They are expanded
before the code block is parsed, so to the Lua interpreter the inline variables
look like regular constants.</p>

<h3 id="hints-for-using-code-blocks">Hints for using code blocks</h3>

<p>Most simple mathematical expressions work just like you'd expect them to.
Operator precedence rules are those of regular arithmetic.</p>

<p>A code block should always return a string or numeric value, if it returns a
boolean, a table or something else it might cause a warning and the resulting
line containing the wrong output.</p>

<p>To create simple conditionals within code blocks you can use the <code>and</code> and <code>or</code>
operators to chain values and conditions. For example:</p>

<pre class="highlight text">{\k!syl.duration &gt; 100 and &quot;f&quot; or &quot;&quot;!$kdur}
</pre>
<p>If the syllable duration is longer than 100 ms the first sub-expression is
true, and the code block returns <tt>"f"</tt>, otherwise the entire <code>and</code>
expression is false, and the right-hand argument of the <code>or</code> expression is
returned.</p>

<p>In Lua, <code>and</code> binds stronger than <code>or</code> meaning that <code>and</code> expressions are
evaluated first. In the above expression the effective grouping is like this:
<code>((syl.duration &gt; 100) and &quot;f&quot;) or &quot;&quot;</code></p>

<div class='navbox'>
<div><a href="../../../Automation/index.html">Automation</a></div>
<table>
<tr>
<th>Overview:</th>
<td><a href="../../../Automation/Manager/index.html">Automation Manager</a> • <a href="../../../Automation/Running_macros/index.html">Running macros</a> • <a href="../../../Exporting/index.html">Using export filters</a> • <a href="../../../Automation/Included_macros/index.html">Standard macros</a></td>
</tr>
<tr>
<th><a href="../../../Automation/Karaoke_Templater/index.html">Karaoke Templater</a> reference:</th>
<td><a href="../../../Automation/Karaoke_Templater/Declaring_template_and_code_lines/index.html">Declaring templates</a> • <a href="../../../Automation/Karaoke_Templater/Template_execution_rules_and_order/index.html">Execution order</a> • <a href="../../../Automation/Karaoke_Templater/Template_modifiers/index.html">Modifiers</a> • <a href="../../../Automation/Karaoke_Templater/Inline_variables/index.html">Inline-variables ($-variables)</a> <br> <a href="../../../Automation/Karaoke_Templater/Code_lines_and_blocks/index.html">Code lines and blocks</a> • <a href="../../../Automation/Karaoke_Templater/Code_execution_environment/index.html">Execution envirionment</a></td>
</tr>
<tr>
<th><a href="../../../Automation/Lua/index.html">Lua API</a>  reference:</th>
<td><a href="../../../Automation/Lua/Registration/index.html">Registration</a> • <a href="../../../Automation/Lua/Subtitle_file_interface/index.html">Subtitles object</a> • <a href="../../../Automation/Lua/Progress_reporting/index.html">Progress reporting</a> • <a href="../../../Automation/Lua/Dialogs/index.html">Dialogs</a> • <a href="../../../Automation/Lua/Miscellaneous_APIs/index.html">Misc. APIs</a></td>
</tr>
<tr>
<th><a href="../../../Automation/Lua/Modules/index.html">Lua Modules</a>:</th>
<td><a href="../../../Automation/Lua/Modules/karaskel.lua/index.html">karaskel.lua</a> • <a href="../../../Automation/Lua/Modules/util/index.html">util</a> • <a href="../../../Automation/Lua/Modules/unicode/index.html">unicode</a> • <a href="#">cleantags.lua</a> • <a href="../../../Automation/Lua/Modules/clipboard/index.html">clipboard</a> • <a href="../../../Automation/Lua/Modules/re/index.html">re</a></td>
</tr>
<tr>
<th>Karaskel concepts:</th>
<td><a href="../../../Automation/Lua/Modules/karaskel.lua/index.html#Style_table">Style tables</a> • <a href="../../../Automation/Lua/Modules/karaskel.lua/index.html#Dialogue_line_table">Dialogue line tables</a> • <a href="../../../Automation/Lua/Modules/karaskel.lua/index.html#Karaoke_and_furigana_syllable_tables">Syllable tables</a> • <a href="../../../Karaoke_inline-fx/index.html">Inline effects</a> • <a href="../../../Furigana_karaoke/index.html">Furigana</a></td>
</tr>
</table>
</div>


</div>
</div>

<footer class='footer span12 pagination-centered'>
<p>
Hosting kindly provided by
<a href='http://www.networkredux.com/'>NetworkRedux</a>
</p>
</footer>
</body>

<!-- Mirrored from docs.aegisub.org/3.1/Automation/Karaoke_Templater/Code_lines_and_blocks/ by HTTrack Website Copier/3.x [XR&CO'2014], Wed, 08 Jul 2020 19:49:04 GMT -->
</html>

