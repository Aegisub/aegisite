<!doctype html><html lang=en-us><head><meta charset=utf-8><meta http-equiv=x-ua-compatible content="ie=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><link rel=preload as=font href=https://aegisub.github.io/aegisite/fonts/vendor/jost/jost-v4-latin-regular.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://aegisub.github.io/aegisite/fonts/vendor/jost/jost-v4-latin-500.woff2 type=font/woff2 crossorigin><link rel=preload as=font href=https://aegisub.github.io/aegisite/fonts/vendor/jost/jost-v4-latin-700.woff2 type=font/woff2 crossorigin><script>(()=>{var t=window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches,e=localStorage.getItem("theme");t&&e===null&&(localStorage.setItem("theme","dark"),document.documentElement.setAttribute("data-dark-mode","")),t&&e==="dark"&&document.documentElement.setAttribute("data-dark-mode",""),e==="dark"&&document.documentElement.setAttribute("data-dark-mode","")})()</script><link rel=stylesheet href=https://aegisub.github.io/aegisite/main.77eb1ac9237938a6ba5d032ac978f4bbe62b8253c372e6a982d6ef0d8eb7b49ef43fd743431de8d239dc6e51602c3fe0720c9b309aa19b004689a31668d68dfc.css integrity="sha512-d+saySN5OKa6XQMqyXj0u+YrglPDcuapgtbvDY63tJ70P9dDQx3o0jncblFgLD/gcgybMJqhmwBGiaMWaNaN/A==" crossorigin=anonymous><noscript><style>img.lazyload{display:none}.collapse:not(.show){display:block}button.btn-toggle{cursor:unset}button.btn-toggle::before{display:none}.doks-subnavbar{display:none}</style></noscript><meta name=robots content="index, follow"><meta name=googlebot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><meta name=bingbot content="index, follow, max-snippet:-1, max-image-preview:large, max-video-preview:-1"><title>Why rendering \k and \kf effects is fast in VSFilter - Aegisub</title><meta name=description content="This is a repost of something I wrote earlier on the AnimeSuki forums, in relation to a discussion of how much CPU time various kinds of karaoke effects take to render.
This discussion only covers TextSub (VSFilter), I don&amp;rsquo;t know what other renderers do and their use is still very limited. Also, everything that goes for \k also goes for \kf, \K and \ko. They use the same rendering technique. This will also explain a funny &amp;ldquo;artifact&amp;rdquo; some karaokers might have seen when using \kf with vertical karaoke."><link rel=canonical href=https://aegisub.github.io/aegisite/blog/why-rendering-%5Ck-and-%5Ckf-effects-is-fast-in-vsfilter/><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="og:title" content="Why rendering \k and \kf effects is fast in VSFilter"><meta property="og:description" content="This is a repost of something I wrote earlier on the AnimeSuki forums, in relation to a discussion of how much CPU time various kinds of karaoke effects take to render.
This discussion only covers TextSub (VSFilter), I don&rsquo;t know what other renderers do and their use is still very limited. Also, everything that goes for \k also goes for \kf, \K and \ko. They use the same rendering technique. This will also explain a funny &ldquo;artifact&rdquo; some karaokers might have seen when using \kf with vertical karaoke."><meta property="og:url" content="https://aegisub.github.io/aegisite/blog/why-rendering-%5Ck-and-%5Ckf-effects-is-fast-in-vsfilter/"><meta property="og:site_name" content="Aegisub"><meta property="article:published_time" content="2008-07-20T22:23:00+01:00"><meta property="article:modified_time" content="2008-07-22T01:18:34+01:00"><meta property="og:image" content="https://aegisub.github.io/aegisite/img/logo.png"><meta property="og:image:alt" content="Aegisub"><meta name=twitter:card content="summary_large_image"><meta name=twitter:site content="@aegisub"><meta name=twitter:creator content><meta name=twitter:title content="Why rendering \k and \kf effects is fast in VSFilter"><meta name=twitter:description content><meta name=twitter:image content="https://aegisub.github.io/aegisite/img/logo.png"><meta name=twitter:image:alt content="Why rendering \k and \kf effects is fast in VSFilter"><script type=application/ld+json>{"@context":"https://schema.org","@graph":[{"@type":"Organization","@id":"https://aegisub.github.io/#/schema/organization/1","name":"Aegisub","url":"https://aegisub.github.io/","sameAs":["https://twitter.com/aegisub","https://github.com/Aegisub/Aegisub"],"logo":{"@type":"ImageObject","@id":"https://aegisub.github.io/#/schema/image/1","url":"https://aegisub.github.io/logo-aegisub.png","width":512,"height":512,"caption":"Aegisub"},"image":{"@id":"https://aegisub.github.io/#/schema/image/1"}},{"@type":"WebSite","@id":"https://aegisub.github.io/#/schema/website/1","url":"https://aegisub.github.io/","name":"Aegisub","description":"Aegisub is a free, cross-platform open source tool for creating and modifying subtitles. Aegisub makes it quick and easy to time subtitles to audio, and features many powerful tools for styling them, including a built-in real-time video preview.","publisher":{"@id":"https://aegisub.github.io/#/schema/organization/1"}},{"@type":"WebPage","@id":"https://aegisub.github.io/aegisite/blog/why-rendering-%5Ck-and-%5Ckf-effects-is-fast-in-vsfilter/","url":"https://aegisub.github.io/aegisite/blog/why-rendering-%5Ck-and-%5Ckf-effects-is-fast-in-vsfilter/","name":"Why rendering \\k and \\kf effects is fast in VSFilter","description":"","isPartOf":{"@id":"https://aegisub.github.io/#/schema/website/1"},"about":{"@id":"https://aegisub.github.io/#/schema/organization/1"},"datePublished":"2008-07-20T22:23:00CET","dateModified":"2008-07-22T01:18:34CET","breadcrumb":{"@id":"https://aegisub.github.io/aegisite/blog/why-rendering-%5Ck-and-%5Ckf-effects-is-fast-in-vsfilter/#/schema/breadcrumb/1"},"primaryImageOfPage":{"@id":"https://aegisub.github.io/aegisite/blog/why-rendering-%5Ck-and-%5Ckf-effects-is-fast-in-vsfilter/#/schema/image/2"},"inLanguage":"en-US","potentialAction":[{"@type":"ReadAction","target":["https://aegisub.github.io/aegisite/blog/why-rendering-%5Ck-and-%5Ckf-effects-is-fast-in-vsfilter/"]}]},{"@type":"BreadcrumbList","@id":"https://aegisub.github.io/aegisite/blog/why-rendering-%5Ck-and-%5Ckf-effects-is-fast-in-vsfilter/#/schema/breadcrumb/1","name":"Breadcrumbs","itemListElement":[{"@type":"ListItem","position":1,"item":{"@type":"WebPage","@id":"https://aegisub.github.io/aegisite/","url":"https://aegisub.github.io/aegisite/","name":"Home"}},{"@type":"ListItem","position":2,"item":{"@type":"WebPage","@id":"https://aegisub.github.io/aegisite/blog/","url":"https://aegisub.github.io/aegisite/blog/","name":"Blog"}},{"@type":"ListItem","position":3,"item":{"@id":"https://aegisub.github.io/aegisite/blog/why-rendering-%5Ck-and-%5Ckf-effects-is-fast-in-vsfilter/"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Article","@id":"https://aegisub.github.io/#/schema/article/1","headline":"Why rendering \\k and \\kf effects is fast in VSFilter","description":"","isPartOf":{"@id":"https://aegisub.github.io/aegisite/blog/why-rendering-%5Ck-and-%5Ckf-effects-is-fast-in-vsfilter/"},"mainEntityOfPage":{"@id":"https://aegisub.github.io/aegisite/blog/why-rendering-%5Ck-and-%5Ckf-effects-is-fast-in-vsfilter/"},"datePublished":"2008-07-20T22:23:00CET","dateModified":"2008-07-22T01:18:34CET","author":{"@id":"https://aegisub.github.io/#/schema/person/2"},"publisher":{"@id":"https://aegisub.github.io/#/schema/organization/1"},"image":{"@id":"https://aegisub.github.io/aegisite/blog/why-rendering-%5Ck-and-%5Ckf-effects-is-fast-in-vsfilter/#/schema/image/2"}}]},{"@context":"https://schema.org","@graph":[{"@type":"Person","@id":"https://aegisub.github.io/#/schema/person/2","name":null,"sameAs":[]}]},{"@context":"https://schema.org","@graph":[{"@type":"ImageObject","@id":"https://aegisub.github.io/aegisite/blog/why-rendering-%5Ck-and-%5Ckf-effects-is-fast-in-vsfilter/#/schema/image/2","url":"https://aegisub.github.io/aegisite/img/logo.png","contentUrl":"https://aegisub.github.io/aegisite/img/logo.png","caption":"Why rendering \\k and \\kf effects is fast in VSFilter"}]}]}</script><meta name=theme-color content="#fff"><link rel=apple-touch-icon sizes=180x180 href=https://aegisub.github.io/aegisite/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://aegisub.github.io/aegisite/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://aegisub.github.io/aegisite/favicon-16x16.png><link rel=manifest crossorigin=use-credentials href=https://aegisub.github.io/aegisite/site.webmanifest></head><body class="blog single"><div class=sticky-lg-top><div class=header-bar></div><header class="navbar navbar-expand-md navbar-light doks-navbar"><nav class="container-fluid flex-wrap flex-md-nowrap" aria-label="Main navigation"><a class="navbar-brand p-0 me-auto" href=https://aegisub.github.io/aegisite/ aria-label=Aegisub>Aegisub</a>
<button class="btn btn-menu d-block d-md-none order-5" type=button data-bs-toggle=offcanvas data-bs-target=#offcanvasDoks aria-controls=offcanvasDoks aria-label="Open main menu"><svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-menu"><line x1="3" y1="12" x2="21" y2="12"/><line x1="3" y1="6" x2="21" y2="6"/><line x1="3" y1="18" x2="21" y2="18"/></svg></button><div class="offcanvas offcanvas-end border-0 py-md-1" tabindex=-1 id=offcanvasDoks data-bs-backdrop=true aria-labelledby=offcanvasDoksLabel><div class="header-bar d-md-none"></div><div class="offcanvas-header d-md-none"><h2 class="h5 offcanvas-title ps-2" id=offcanvasDoksLabel><a class=text-dark href=https://aegisub.github.io/aegisite/>Aegisub</a></h2><button type=button class="btn-close text-reset me-2" data-bs-dismiss=offcanvas aria-label="Close main menu"></button></div><div class="offcanvas-body px-4"><h3 class="h6 text-uppercase mb-3 d-md-none">Main</h3><ul class="nav flex-column flex-md-row ms-md-n3"><li class=nav-item><a class="nav-link ps-0 py-1" href=https://aegisub.github.io/aegisite/downloads/main/>Downloads</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=https://aegisub.github.io/aegisite/docs/>Docs</a></li><li class=nav-item><a class="nav-link ps-0 py-1" href=https://github.com/Aegisub/Aegisub/issues>Bug Tracker</a></li><li class=nav-item><a class="nav-link ps-0 py-1 active" href=https://aegisub.github.io/aegisite/blog/>Blog</a></li></ul><hr class="text-black-50 my-4 d-md-none"><h3 class="h6 text-uppercase mb-3 d-md-none">Socials</h3><ul class="nav flex-column flex-md-row ms-md-auto me-md-n5 pe-md-2"><li class=nav-item><a class="nav-link ps-0 py-1" href=https://github.com/Aegisub/Aegisub aria-label="View repository on GitHub"><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-github"><path d="M9 19c-5 1.5-5-2.5-7-3m14 6v-3.87a3.37 3.37.0 00-.94-2.61c3.14-.35 6.44-1.54 6.44-7A5.44 5.44.0 0020 4.77 5.07 5.07.0 0019.91 1S18.73.65 16 2.48a13.38 13.38.0 00-7 0C6.27.65 5.09 1 5.09 1A5.07 5.07.0 005 4.77 5.44 5.44.0 003.5 8.55c0 5.42 3.3 6.61 6.44 7A3.37 3.37.0 009 18.13V22"/></svg><small class="ms-2 d-md-none">GitHub</small></a></li></ul></div></div><button id=mode class="btn btn-link order-md-1" type=button aria-label="Toggle user interface mode">
<span class=toggle-dark><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-moon"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg></span><span class=toggle-light><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-sun"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></span></button><div class="dropdown order-md-2"><button class="btn btn-doks-light dropdown-toggle" id=doks-languages data-bs-toggle=dropdown aria-expanded=false data-bs-display=static>
EN
<span class=dropdown-caret><svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"/></svg></span></button><ul class="dropdown-menu dropdown-menu-end shadow rounded border-0" aria-labelledby=doks-languages><li><a class="dropdown-item current" aria-current=true href=https://aegisub.github.io/aegisite/blog/why-rendering-%5Ck-and-%5Ckf-effects-is-fast-in-vsfilter/>English</a></li><li><hr class=dropdown-divider></li><li><a class=dropdown-item rel=alternate href=https://aegisub.github.io/aegisite/zh-cn/blog/why-rendering-%5Ck-and-%5Ckf-effects-is-fast-in-vsfilter/ hreflang=zh-cn lang=zh-cn>简体中文</a></li></ul></div></nav></header></div><div class="wrap container-fluid" role=document><div class=content><div class="row justify-content-center"><div class="col-md-12 col-lg-10 col-xl-8"><article><div class=blog-header><h1>Why rendering \k and \kf effects is fast in VSFilter</h1><p><small>Posted July 20, 2008 by <a class="stretched-link position-relative" href=https://aegisub.github.io/aegisite/contributors/jfs/>jfs</a>&nbsp;&dash;&nbsp;<strong>3&nbsp;min read</strong></small><p></div><p class=lead></p><p><em>This is a repost of something I wrote earlier <a href="http://forums.animesuki.com/showpost.php?p=1629372&postcount=72">on the AnimeSuki forums</a>, in relation to a discussion of how much CPU time various kinds of karaoke effects take to render.</em></p><p>This discussion only covers TextSub (VSFilter), I don&rsquo;t know what other renderers do and their use is still very limited. Also, everything that goes for \k also goes for \kf, \K and \ko. They use the same rendering technique.
This will also explain a funny &ldquo;artifact&rdquo; some karaokers might have seen when using \kf with vertical karaoke.</p><p>First, while TextSub does have a function that should tell whether a line is animated or not (presumably so it could avoid re-rendering static lines for every frame) that function is empty, it just says &ldquo;return true;&rdquo;, so every line is always considered animated, no matter what&rsquo;s in it.</p><p>Next, the way \k effects are handled is using a &ldquo;switchpoints&rdquo; algorithm.
TextSub renders (up to) three different single-channel 6-bit bitmaps for each line, fill, border and shadow. (Border is Shadow minus Fill. Shadow is Fill &ldquo;expanded&rdquo; to give an outline.)
When the subtitle is to be painted onto the video, TextSub builds a list of switchpoints for each line component. A switchpoint has two parts: Colour (which includes alpha) and end-coordinate. The end-coordinate is which pixel index on the scanline the colour is valid up till.
(When a line has a vector-\clip, the vector drawing is rendered as a fourth 6-bit image which is used to mask the other layers while painting.)</p><p>When there is no \k effect, there is only one switchpoint for each component, which has the colour of it and the end-coordinate set to infinity (actually 0xFFFFFFFF).
When there is a \k effect, the current position of the highlight is calculated for the frame, and a switchpoint is added at the right coordinate. This is very fast to calculate. The pixel size of every syllable is already known (because the rasteriser breaks the line into &ldquo;words&rdquo; at every change in formatting - \k tags are formatting) and for \kf effects, getting the position within the syllable is a matter of simple linear interpolation between the endpoints of the syllable.</p><p>Now for painting an actual component.
For every scanline of the component, loop over each switchpoint. For each switchpoint, paint its colour to the video frame, using the component as mask and optionally also masking with a vector-\clip mask. When the endpoint of a switchpoint is reached, do the same for the next switchpoint, continuing where the previous one left off.
This is repeated for every scanline of the component. Also very fast.
(The case of just a single switchpoint, ie. no \k effect, is questionably optimised by removing the switchpoints-loop. I think this in practice only saves a few hundred or maybe thousand machine instructions in total for each component, but I haven&rsquo;t checked the actual code.)</p><p>For the reason why \k effects don&rsquo;t rotate when you use \frz (and family): They are scanline-based and the switchpoints are assumed to always be on the same coordinate on every scanline. The switchpoints can&rsquo;t change between scanlines for the same component.</p><p>This should explain why \k effects are fast to render, unlike many \t-based effects. Using purely \k-based karaoke effects is safe to do when softsubbing, any modern CPU should be able to render it, since it doesn&rsquo;t really take any more CPU than rendering static lines.</p></article></div></div></div></div><footer class="footer text-muted"><div class=container-fluid><div class=row><div class="col-lg-8 order-last order-lg-first"><ul class=list-inline><li class=list-inline-item>Powered by <a class=text-muted href=https://gohugo.io/>Hugo</a> and <a class=text-muted href=https://getdoks.org/>Doks</a>.<br>Copyright (c) AegiSite <a href=https://github.com/Aegisub/aegisite/graphs/contributors>contributors</a>.</li></ul></div><div class="col-lg-8 order-first order-lg-last text-lg-end"><ul class=list-inline><li class=list-inline-item><a href=https://aegisub.github.io/aegisite/privacy-policy/>Privacy</a></li></ul></div></div></div></footer><script src=https://aegisub.github.io/aegisite/js/bootstrap.min.0a0106334435d4110713bfaff4acaf02533b0c56d44412a74e9518db07672ddb7e099a9c7517bc9cb529e2ddd4ae2e438b40b720288900d5e74fb6d8928d9097.js integrity="sha512-CgEGM0Q11BEHE7+v9KyvAlM7DFbURBKnTpUY2wdnLdt+CZqcdRe8nLUp4t3Uri5Di0C3ICiJANXnT7bYko2Qlw==" crossorigin=anonymous defer></script>
<script src=https://aegisub.github.io/aegisite/js/highlight.min.79d4a0760edf1098d3895cc3fcd9e08f498eb6ff105d11f717ca93f231ba9dd47c0b826eaf0753b87415f66798dd5320ef6e4e09e1d8d06efcc34b54d6597e01.js integrity="sha512-edSgdg7fEJjTiVzD/Nngj0mOtv8QXRH3F8qT8jG6ndR8C4JurwdTuHQV9meY3VMg725OCeHY0G78w0tU1ll+AQ==" crossorigin=anonymous defer></script>
<script src=https://aegisub.github.io/aegisite/main.min.6f7a46bd1f121978f9b99a72930700eeeea078245b498f61330d43745353ee2a541491c87fd8307512f49a752b386387e2c265a11377ecce26a2acb8fa24fecf.js integrity="sha512-b3pGvR8SGXj5uZpykwcA7u6geCRbSY9hMw1DdFNT7ipUFJHIf9gwdRL0mnUrOGOH4sJloRN37M4moqy4+iT+zw==" crossorigin=anonymous defer></script></body></html>